<!-- Controls/AdvancedDataGrid.xaml - ✅ KOMPLETNE OPRAVENÝ pre jednotné rozmery -->
<UserControl
    x:Class="RpaWinUiComponents.AdvancedWinUiDataGrid.AdvancedDataGrid"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:RpaWinUiComponents.AdvancedWinUiDataGrid"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!-- ✅ OPRAVENÉ: Lokálne definície converterov -->
        <local:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <local:InvertedBoolToVisibilityConverter x:Key="InvertedBoolToVisibilityConverter"/>
        <local:BoolToValidationBrushConverter x:Key="BoolToValidationBrushConverter"/>
        <local:BoolToValidationThicknessConverter x:Key="BoolToValidationThicknessConverter"/>

        <!-- ✅ ROZŠÍRENÉ: Color Theme Resources s binding na ColorTheme property -->
        <SolidColorBrush x:Key="CellBackgroundBrush" Color="{x:Bind ColorTheme.CellBackgroundColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="CellBorderBrush" Color="{x:Bind ColorTheme.CellBorderColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="CellTextBrush" Color="{x:Bind ColorTheme.CellTextColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="HeaderBackgroundBrush" Color="{x:Bind ColorTheme.HeaderBackgroundColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="HeaderTextBrush" Color="{x:Bind ColorTheme.HeaderTextColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="ValidationErrorBrush" Color="{x:Bind ColorTheme.ValidationErrorColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="SelectionBrush" Color="{x:Bind ColorTheme.SelectionColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="EditingCellBrush" Color="{x:Bind ColorTheme.EditingCellColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="HoverBrush" Color="{x:Bind ColorTheme.HoverColor, Mode=OneWay}"/>
        <SolidColorBrush x:Key="AlternateRowBrush" Color="{x:Bind ColorTheme.AlternateRowColor, Mode=OneWay}"/>


        <!-- ✅ OPRAVENÉ: Header Template s FIXED sizing a hover effects -->
        <DataTemplate x:Key="HeaderTemplate">
            <Border Background="{StaticResource HeaderBackgroundBrush}"
                    BorderBrush="{StaticResource CellBorderBrush}"
                    BorderThickness="0,0,1,1"
                    Padding="8,6"
                    Height="40"
                    MinWidth="{Binding MinWidth, FallbackValue=100}"
                    MaxWidth="{Binding MaxWidth, FallbackValue=300}">

                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Setters>
                            <Setter Property="Background" Value="{StaticResource HeaderBackgroundBrush}"/>
                        </Style.Setters>
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource HoverBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <TextBlock Text="{Binding Header}" 
                          FontWeight="SemiBold"
                          Foreground="{StaticResource HeaderTextBrush}"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Left"
                          TextWrapping="NoWrap"
                          TextTrimming="CharacterEllipsis"/>
            </Border>
        </DataTemplate>

        <!-- ✅ KOMPLETNE OPRAVENÉ: Cell Template s fixed sizing, realtime validáciou a editing states -->
        <DataTemplate x:Key="CellTemplate">
            <Border x:Name="CellBorder"
                    Padding="8,6"
                    MinHeight="36"
                    MinWidth="{Binding ColumnDefinition.MinWidth, FallbackValue=100}"
                    MaxWidth="{Binding ColumnDefinition.MaxWidth, FallbackValue=300}">

                <!-- ✅ Dynamic background based na editing state -->
                <Border.Background>
                    <SolidColorBrush>
                        <SolidColorBrush.Color>
                            <Binding Path="IsEditing" Converter="{StaticResource EditingStateToBrushConverter}" 
                                     FallbackValue="{x:Bind ColorTheme.CellBackgroundColor, Mode=OneWay}"/>
                        </SolidColorBrush.Color>
                    </SolidColorBrush>
                </Border.Background>

                <!-- ✅ Dynamic border based na validation state -->
                <Border.BorderBrush>
                    <SolidColorBrush>
                        <SolidColorBrush.Color>
                            <Binding Path="IsValid" Converter="{StaticResource ValidationStateToBorderColorConverter}"
                                     FallbackValue="{x:Bind ColorTheme.CellBorderColor, Mode=OneWay}"/>
                        </SolidColorBrush.Color>
                    </SolidColorBrush>
                </Border.BorderBrush>

                <Border.BorderThickness>
                    <Binding Path="IsValid" Converter="{StaticResource BoolToValidationThicknessConverter}"/>
                </Border.BorderThickness>

                <Border.Style>
                    <Style TargetType="Border">
                        <Style.Triggers>
                            <Trigger Property="IsMouseOver" Value="True">
                                <Setter Property="Background" Value="{StaticResource HoverBrush}"/>
                            </Trigger>
                        </Style.Triggers>
                    </Style>
                </Border.Style>

                <TextBox x:Name="CellTextBox"
                        Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Background="Transparent"
                        Foreground="{StaticResource CellTextBrush}"
                        BorderThickness="0"
                        Padding="0"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        VerticalAlignment="Stretch"
                        HorizontalAlignment="Stretch"
                        KeyDown="OnCellKeyDown"
                        LostFocus="OnCellLostFocus"
                        GotFocus="OnCellGotFocus"
                        TextChanged="OnCellTextChanged"
                        Tag="{Binding}"/>
            </Border>
        </DataTemplate>

        <!-- ✅ OPRAVENÉ: Delete Button Template s fixed sizing -->
        <DataTemplate x:Key="DeleteButtonTemplate">
            <Border Background="{StaticResource CellBackgroundBrush}"
                    BorderBrush="{StaticResource CellBorderBrush}"
                    BorderThickness="0,0,1,1"
                    Padding="4"
                    MinHeight="36"
                    Width="40">
                <Button Background="Transparent"
                        BorderThickness="0"
                        Width="24"
                        Height="24"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Click="OnDeleteRowClick"
                        Tag="{Binding}">
                    <FontIcon Glyph="&#xE74D;" 
                             FontSize="12"
                             Foreground="{StaticResource ValidationErrorBrush}"/>
                </Button>
            </Border>
        </DataTemplate>

        <!-- ✅ OPRAVENÉ: Validation Alerts Template s fixed sizing -->
        <DataTemplate x:Key="ValidationAlertsTemplate">
            <Border Background="{StaticResource CellBackgroundBrush}"
                    BorderBrush="{StaticResource CellBorderBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="8,6"
                    MinHeight="36"
                    MinWidth="200">
                <ScrollViewer VerticalScrollBarVisibility="Auto" 
                              HorizontalScrollBarVisibility="Disabled"
                              MaxHeight="100">
                    <TextBlock Text="{Binding ValidationErrors}" 
                              Foreground="{StaticResource ValidationErrorBrush}"
                              FontSize="12"
                              TextWrapping="Wrap"
                              VerticalAlignment="Center"/>
                </ScrollViewer>
            </Border>
        </DataTemplate>

        <!-- ✅ NOVÉ: Row Template pre jednotné sizing -->
        <DataTemplate x:Key="RowTemplate">
            <ItemsRepeater ItemsSource="{Binding Cells}" x:Name="RowCellsRepeater">
                <ItemsRepeater.Layout>
                    <StackLayout Orientation="Horizontal" Spacing="0"/>
                </ItemsRepeater.Layout>
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate>
                        <ContentPresenter Content="{Binding}" 
                                        ContentTemplateSelector="{StaticResource CellTemplateSelector}"/>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </DataTemplate>

        <!-- ✅ NOVÉ: Template Selector pre rôzne typy buniek -->
        <local:CellTemplateSelector x:Key="CellTemplateSelector"
                                   CellTemplate="{StaticResource CellTemplate}"
                                   DeleteButtonTemplate="{StaticResource DeleteButtonTemplate}"
                                   ValidationAlertsTemplate="{StaticResource ValidationAlertsTemplate}"/>
    </UserControl.Resources>

    <Grid>
        <!-- ✅ OPRAVENÉ: Loading Overlay -->
        <Border x:Name="LoadingOverlay"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                Visibility="Collapsed">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                <ProgressRing IsActive="True" Width="32" Height="32"/>
                <TextBlock x:Name="LoadingText" 
                          Text="Inicializuje sa DataGrid..."
                          FontSize="14"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- ✅ OPRAVENÉ: Main Content s fixed column sizing -->
        <Grid x:Name="MainContentGrid" Visibility="Visible">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- ✅ OPRAVENÉ: Header s fixed column widths -->
            <ScrollViewer x:Name="HeaderScrollViewer"
                         Grid.Row="0"
                         HorizontalScrollBarVisibility="Hidden"
                         VerticalScrollBarVisibility="Disabled"
                         ZoomMode="Disabled">
                <ItemsRepeater x:Name="HeaderRepeater" ItemsSource="{x:Bind HeaderColumns, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Horizontal" Spacing="0"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding}" 
                                            ContentTemplate="{StaticResource HeaderTemplate}"/>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>

            <!-- ✅ OPRAVENÉ: Data ScrollViewer s multi-selection support -->
            <ScrollViewer x:Name="DataScrollViewer"
                         Grid.Row="1"
                         HorizontalScrollBarVisibility="Auto"
                         VerticalScrollBarVisibility="Auto"
                         ZoomMode="Disabled"
                         ViewChanged="OnDataScrollViewChanged">

                <ItemsRepeater x:Name="DataRowsRepeater" ItemsSource="{x:Bind DataRows, Mode=OneWay}">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Vertical" Spacing="0"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding}" 
                                            ContentTemplate="{StaticResource RowTemplate}"/>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>

        <!-- ✅ NOVÉ: Multi-selection overlay -->
        <Canvas x:Name="SelectionCanvas" 
                Grid.Row="1"
                Background="Transparent"
                IsHitTestVisible="True"
                PointerPressed="OnSelectionCanvasPointerPressed"
                PointerMoved="OnSelectionCanvasPointerMoved"
                PointerReleased="OnSelectionCanvasPointerReleased"/>
    </Grid>
</UserControl>