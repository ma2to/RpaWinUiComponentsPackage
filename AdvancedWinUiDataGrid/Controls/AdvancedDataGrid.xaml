<!-- Controls/AdvancedDataGrid.xaml -->
<UserControl
    x:Class="RpaWinUiComponents.AdvancedWinUiDataGrid.AdvancedDataGrid"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:local="using:RpaWinUiComponents.AdvancedWinUiDataGrid"
    xmlns:utilities="using:RpaWinUiComponents.AdvancedWinUiDataGrid.Utilities"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    mc:Ignorable="d">

    <UserControl.Resources>
        <!-- ✅ OPRAVENÉ: Pridané convertery -->
        <utilities:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <utilities:InvertedBoolToVisibilityConverter x:Key="InvertedBoolToVisibilityConverter"/>
        <utilities:BoolToValidationBrushConverter x:Key="BoolToValidationBrushConverter"/>
        <utilities:BoolToValidationThicknessConverter x:Key="BoolToValidationThicknessConverter"/>

        <!-- Header Template -->
        <DataTemplate x:Key="HeaderTemplate">
            <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,1"
                    Padding="8,12"
                    MinHeight="40">
                <TextBlock Text="{Binding}" 
                          FontWeight="SemiBold"
                          VerticalAlignment="Center"
                          TextWrapping="Wrap"/>
            </Border>
        </DataTemplate>

        <!-- Cell Template -->
        <DataTemplate x:Key="CellTemplate">
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{Binding IsValid, Converter={StaticResource BoolToValidationBrushConverter}}"
                    BorderThickness="{Binding IsValid, Converter={StaticResource BoolToValidationThicknessConverter}}"
                    Padding="8,6"
                    MinHeight="36">
                <TextBox Text="{Binding Value, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                        Background="Transparent"
                        BorderThickness="0"
                        Padding="0"
                        AcceptsReturn="True"
                        TextWrapping="Wrap"
                        VerticalAlignment="Stretch"
                        KeyDown="OnCellKeyDown"
                        LostFocus="OnCellLostFocus"
                        GotFocus="OnCellGotFocus"/>
            </Border>
        </DataTemplate>

        <!-- Delete Button Template -->
        <DataTemplate x:Key="DeleteButtonTemplate">
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,1"
                    Padding="4"
                    MinHeight="36">
                <Button Background="Transparent"
                        BorderThickness="0"
                        Width="24"
                        Height="24"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center"
                        Click="OnDeleteRowClick"
                        Tag="{Binding}">
                    <FontIcon Glyph="&#xE74D;" 
                             FontSize="12"
                             Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                </Button>
            </Border>
        </DataTemplate>

        <!-- Validation Alerts Template -->
        <DataTemplate x:Key="ValidationAlertsTemplate">
            <Border Background="{ThemeResource LayerFillColorDefaultBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,0,1"
                    Padding="8,6"
                    MinHeight="36">
                <TextBlock Text="{Binding ValidationErrors}" 
                          Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                          FontSize="12"
                          TextWrapping="Wrap"
                          VerticalAlignment="Center"/>
            </Border>
        </DataTemplate>

        <!-- Row Template -->
        <DataTemplate x:Key="RowTemplate">
            <ItemsRepeater ItemsSource="{Binding Cells}" Layout="{StaticResource RowLayout}">
                <ItemsRepeater.ItemTemplate>
                    <DataTemplate>
                        <ContentPresenter Content="{Binding}" 
                                        ContentTemplate="{Binding CellTemplate}"/>
                    </DataTemplate>
                </ItemsRepeater.ItemTemplate>
            </ItemsRepeater>
        </DataTemplate>

        <!-- Row Layout -->
        <StackLayout x:Key="RowLayout" Orientation="Horizontal" Spacing="0"/>

        <!-- Header Layout -->
        <StackLayout x:Key="HeaderLayout" Orientation="Horizontal" Spacing="0"/>
    </UserControl.Resources>

    <Grid>
        <!-- ✅ OPRAVENÉ: Loading Overlay s potrebnými elementmi -->
        <Border x:Name="LoadingOverlay"
                Background="{ThemeResource LayerFillColorDefaultBrush}"
                Visibility="Visible">
            <StackPanel HorizontalAlignment="Center" VerticalAlignment="Center" Spacing="12">
                <ProgressRing IsActive="True" Width="32" Height="32"/>
                <TextBlock x:Name="LoadingText" 
                          Text="Inicializuje sa DataGrid..."
                          FontSize="14"
                          Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                          HorizontalAlignment="Center"/>
            </StackPanel>
        </Border>

        <!-- Main Content -->
        <Grid Visibility="{Binding ElementName=LoadingOverlay, Path=Visibility, Converter={StaticResource InvertedBoolToVisibilityConverter}}">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- ✅ OPRAVENÉ: Header s potrebnými elementmi -->
            <ScrollViewer x:Name="HeaderScrollViewer"
                         Grid.Row="0"
                         HorizontalScrollBarVisibility="Hidden"
                         VerticalScrollBarVisibility="Disabled"
                         ZoomMode="Disabled">
                <ItemsRepeater x:Name="HeaderRepeater" 
                              Layout="{StaticResource HeaderLayout}">
                    <ItemsRepeater.ItemTemplate>
                        <DataTemplate>
                            <ContentPresenter Content="{Binding}" 
                                            ContentTemplate="{StaticResource HeaderTemplate}"/>
                        </DataTemplate>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>

            <!-- ✅ OPRAVENÉ: Data ScrollViewer s potrebnými elementmi -->
            <ScrollViewer x:Name="DataScrollViewer"
                         Grid.Row="1"
                         HorizontalScrollBarVisibility="Auto"
                         VerticalScrollBarVisibility="Auto"
                         ZoomMode="Disabled"
                         ViewChanged="OnDataScrollViewChanged">
                <ItemsRepeater x:Name="DataRowsRepeater">
                    <ItemsRepeater.Layout>
                        <StackLayout Orientation="Vertical" Spacing="0"/>
                    </ItemsRepeater.Layout>
                    <ItemsRepeater.ItemTemplate>
                        <StaticResource ResourceKey="RowTemplate"/>
                    </ItemsRepeater.ItemTemplate>
                </ItemsRepeater>
            </ScrollViewer>
        </Grid>
    </Grid>
</UserControl>