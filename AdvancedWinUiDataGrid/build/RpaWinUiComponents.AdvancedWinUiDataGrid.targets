<!-- AdvancedWinUiDataGrid/build/RpaWinUiComponents.AdvancedWinUiDataGrid.targets -->
<!-- ✅ KOMPLETNE OPRAVENÉ: MSBuild targets s XBF copying fix pre Package Reference -->
<Project>

  <!-- ✅ Debug informácie -->
  <Target Name="DebugAdvancedDataGridPackage" BeforeTargets="ResolveReferences" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">
    <Message Text="🔍 AdvancedWinUiDataGrid: Package v1.0.12 loaded via NuGet (XBF loading FIXED)" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: MSBuildThisFileDirectory = $(MSBuildThisFileDirectory)" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: TargetFramework = $(TargetFramework)" Importance="normal" />
  </Target>

  <!-- ✅ OPRAVENÉ: Package paths s XBF support -->
  <PropertyGroup>
    <!-- ✅ Priorita: Aktuálny TFM (presne ako je definovaný) -->
    <AdvancedDataGridLibPath Condition="Exists('$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/')">$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/</AdvancedDataGridLibPath>

    <!-- ✅ Fallback na dlhý formát ak aktuálny neexistuje -->
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/')">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/</AdvancedDataGridLibPath>

    <!-- ✅ Fallback na krátky formát -->
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041/')">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041/</AdvancedDataGridLibPath>

    <!-- ✅ Fallback na generic net8.0-windows -->
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows/')">$(MSBuildThisFileDirectory)../lib/net8.0-windows/</AdvancedDataGridLibPath>

    <!-- ✅ Posledný fallback - default -->
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == ''">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/</AdvancedDataGridLibPath>

    <!-- ✅ Content path pre XAML súbory -->
    <AdvancedDataGridContentPath>$(MSBuildThisFileDirectory)../content/</AdvancedDataGridContentPath>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Assembly reference len ak DLL skutočne existuje -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true'">
    <!-- ✅ Main assembly reference -->
    <Reference Include="AdvancedWinUiDataGrid" Condition="Exists('$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll')">
      <HintPath>$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll</HintPath>
      <Private>False</Private>
    </Reference>

    <!-- ✅ WinUI winmd reference ak existuje -->
    <Reference Include="Microsoft.WinUI" Condition="Exists('$(AdvancedDataGridLibPath)Microsoft.WinUI.winmd')">
      <HintPath>$(AdvancedDataGridLibPath)Microsoft.WinUI.winmd</HintPath>
      <Private>False</Private>
      <IsWinMDFile>true</IsWinMDFile>
    </Reference>
  </ItemGroup>

  <!-- ✅ KĽÚČOVÁ OPRAVA: XBF súbory copying PRED Build (skorší timing) -->
  <Target Name="CopyAdvancedDataGridXbfFiles" BeforeTargets="PrepareForBuild" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="🎨 Copying XBF files from AdvancedDataGrid package ($(Configuration) mode)..." Importance="normal" />

    <!-- ✅ Nájdi všetky XBF súbory v package -->
    <ItemGroup>
      <AdvancedDataGridXbfFiles Include="$(AdvancedDataGridLibPath)**/*.xbf" Condition="Exists('$(AdvancedDataGridLibPath)')" />
    </ItemGroup>

    <!-- ✅ Skopíruj XBF súbory do output directory -->
    <Copy SourceFiles="@(AdvancedDataGridXbfFiles)"
          DestinationFolder="$(OutputPath)%(RecursiveDir)"
          SkipUnchangedFiles="true"
          CreateHardLinksIfPossible="false"
          Condition="'@(AdvancedDataGridXbfFiles)' != ''" />

    <!-- ✅ NOVÉ: Skopíruj aj do intermediate directory -->
    <Copy SourceFiles="@(AdvancedDataGridXbfFiles)"
          DestinationFolder="$(IntermediateOutputPath)%(RecursiveDir)"
          SkipUnchangedFiles="true"
          CreateHardLinksIfPossible="false"
          Condition="'@(AdvancedDataGridXbfFiles)' != ''" />

    <!-- ✅ Log info -->
    <Message Text="✅ Copied @(AdvancedDataGridXbfFiles->Count()) XBF files to output and intermediate directories" Importance="normal" Condition="'@(AdvancedDataGridXbfFiles)' != ''" />
    <Warning Text="⚠️ No XBF files found in package at: $(AdvancedDataGridLibPath)" Condition="'@(AdvancedDataGridXbfFiles)' == ''" />
  </Target>

  <!-- ✅ NOVÉ: Explicit XBF files registration ako Content -->
  <Target Name="RegisterXbfFilesAsContent" AfterTargets="CopyAdvancedDataGridXbfFiles" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="📝 Registering XBF files as content..." Importance="low" />

    <!-- ✅ Find copied XBF files -->
    <ItemGroup>
      <CopiedXbfFiles Include="$(OutputPath)**/*.xbf" />
    </ItemGroup>

    <!-- ✅ Register as content -->
    <ItemGroup Condition="'@(CopiedXbfFiles)' != ''">
      <Content Include="@(CopiedXbfFiles)">
        <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
        <Pack>false</Pack>
      </Content>
    </ItemGroup>

    <Message Text="📝 Registered @(CopiedXbfFiles->Count()) XBF files as content" Importance="low" Condition="'@(CopiedXbfFiles)' != ''" />
  </Target>

  <!-- ✅ NOVÉ: XAML content files ako fallback -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true'">
    <!-- ✅ XAML súbory ako content pre runtime fallback -->
    <Content Include="$(AdvancedDataGridContentPath)Controls/**/*.xaml" Link="AdvancedWinUiDataGrid/Controls/%(RecursiveDir)%(Filename)%(Extension)" Condition="Exists('$(AdvancedDataGridContentPath)Controls/')">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>false</Pack>
    </Content>

    <Content Include="$(AdvancedDataGridContentPath)Themes/*.xaml" Link="AdvancedWinUiDataGrid/Themes/%(Filename)%(Extension)" Condition="Exists('$(AdvancedDataGridContentPath)Themes/')">
      <CopyToOutputDirectory>PreserveNewest</CopyToOutputDirectory>
      <Pack>false</Pack>
    </Content>
  </ItemGroup>

  <!-- ✅ WinUI3 specific nastavenia -->
  <PropertyGroup Condition="'$(UseWinUI)' == 'true'">
    <EnableDefaultXamlItems>true</EnableDefaultXamlItems>
    <XamlCompilationEnabled>true</XamlCompilationEnabled>
    <XamlResourcesEnabled>true</XamlResourcesEnabled>

    <!-- ✅ OPRAVA: Potlač architecture mismatch warnings -->
    <ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>None</ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>

    <!-- ✅ XAML specific nastavenia -->
    <XamlCompileTargetFramework>$(TargetFramework)</XamlCompileTargetFramework>
    <UseCompiledXaml>true</UseCompiledXaml>
  </PropertyGroup>

  <!-- ✅ NOVÝ: XAML Resource resolution target -->
  <Target Name="ResolveAdvancedDataGridXamlResources" BeforeTargets="PrepareForBuild" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="🎨 Resolving XAML resources for AdvancedDataGrid package..." Importance="low" />

    <!-- ✅ Check for XBF files existence -->
    <ItemGroup>
      <ExistingXbfFiles Include="$(AdvancedDataGridLibPath)**/*.xbf" Condition="Exists('$(AdvancedDataGridLibPath)')" />
    </ItemGroup>

    <PropertyGroup>
      <XbfFilesExist Condition="'@(ExistingXbfFiles)' != ''">true</XbfFilesExist>
    </PropertyGroup>

    <Message Text="✅ Found @(ExistingXbfFiles->Count()) XBF files in package" Importance="normal" Condition="'$(XbfFilesExist)' == 'true'" />
    <Message Text="ℹ️ No XBF files found - using XAML fallback" Importance="normal" Condition="'$(XbfFilesExist)' != 'true'" />
  </Target>

  <!-- ✅ OPRAVENÉ: Verification target s podrobným XBF checking -->
  <Target Name="VerifyAdvancedDataGridPackage" BeforeTargets="PrepareForBuild" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">

    <PropertyGroup>
      <PackageDllExists Condition="Exists('$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll')">true</PackageDllExists>
      <PackagePdbExists Condition="Exists('$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.pdb')">true</PackagePdbExists>
      <XamlContentExists Condition="Exists('$(AdvancedDataGridContentPath)Controls/') OR Exists('$(AdvancedDataGridLibPath)')">true</XamlContentExists>
    </PropertyGroup>

    <!-- ✅ Success messages -->
    <Message Text="✅ Using lib path: $(AdvancedDataGridLibPath)" Importance="normal" />
    <Message Text="✅ Using content path: $(AdvancedDataGridContentPath)" Importance="normal" />
    <Message Text="✅ Package DLL found: $(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll"
             Importance="normal"
             Condition="'$(PackageDllExists)' == 'true'" />
    <Message Text="✅ Package PDB found: $(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.pdb"
             Importance="normal"
             Condition="'$(PackagePdbExists)' == 'true'" />
    <Message Text="✅ XAML content found for Package Reference"
             Importance="normal"
             Condition="'$(XamlContentExists)' == 'true'" />

    <!-- ✅ List all files in lib directory for debugging -->
    <ItemGroup Condition="'$(PackageDllExists)' == 'true'">
      <LibraryFiles Include="$(AdvancedDataGridLibPath)*.*" />
    </ItemGroup>
    <Message Text="📁 Files in lib directory: @(LibraryFiles)" Importance="low" Condition="'$(Configuration)' == 'Debug' AND '@(LibraryFiles)' != ''" />

    <!-- ✅ Warning iba ak DLL skutočne neexistuje -->
    <Warning Text="⚠️ AdvancedWinUiDataGrid: DLL not found at expected path. Trying fallback locations..."
             Condition="'$(PackageDllExists)' != 'true' AND '$(DesignTimeBuild)' != 'true'" />

    <Message Text="ℹ️ AdvancedWinUiDataGrid: XAML will be loaded via fallback mechanism"
             Importance="normal"
             Condition="'$(XamlContentExists)' != 'true' AND '$(DesignTimeBuild)' != 'true'" />

    <!-- ✅ Helpful info iba ak je problém -->
    <Message Text="💡 TIP: dotnet clean; dotnet restore --force; dotnet build"
             Importance="normal"
             Condition="'$(PackageDllExists)' != 'true' AND '$(DesignTimeBuild)' != 'true'" />

    <!-- ✅ Success message -->
    <Message Text="🎉 AdvancedWinUiDataGrid package successfully loaded with XAML fix and AUTO-ADD functionality!"
             Importance="high"
             Condition="'$(PackageDllExists)' == 'true' AND '$(XamlContentExists)' == 'true'" />
  </Target>

  <!-- ✅ NOVÉ: Clean duplicates target pre NETSDK1152 fix -->
  <Target Name="CleanDuplicateReferences" BeforeTargets="ResolveReferences" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="🧹 Preventing duplicate assembly references (NETSDK1152 fix)..." Importance="low" />

    <!-- ✅ Remove potential duplicate references -->
    <ItemGroup>
      <ReferencePath Remove="@(ReferencePath)" Condition="'%(ReferencePath.Filename)' == 'AdvancedWinUiDataGrid' AND '%(ReferencePath.DuplicateOf)' != ''" />
    </ItemGroup>
  </Target>

  <!-- ✅ NOVÉ: Post-restore verification -->
  <Target Name="PostRestoreVerification" AfterTargets="Restore" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="📦 Post-restore: Verifying AdvancedWinUiDataGrid package integrity..." Importance="low" />

    <!-- ✅ List available lib folders for debugging -->
    <ItemGroup>
      <AvailableLibFolders Include="$(MSBuildThisFileDirectory)../lib/*/" />
      <AvailableContentFolders Include="$(MSBuildThisFileDirectory)../content/*/" Condition="Exists('$(MSBuildThisFileDirectory)../content/')" />
    </ItemGroup>

    <Message Text="📂 Available lib folders: @(AvailableLibFolders)" Importance="low" Condition="'$(Configuration)' == 'Debug'" />
    <Message Text="📂 Available content folders: @(AvailableContentFolders)" Importance="low" Condition="'$(Configuration)' == 'Debug' AND '@(AvailableContentFolders)' != ''" />
  </Target>

  <!-- ✅ NOVÝ: XAML compilation support for consuming projects -->
  <Target Name="EnsureXamlCompilation" BeforeTargets="XamlPreCompile" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="🎨 Ensuring XAML compilation for AdvancedDataGrid package..." Importance="low" />

    <!-- ✅ Ensure consuming project can find XAML resources -->
    <PropertyGroup>
      <XamlResourceReferencePath>$(AdvancedDataGridLibPath);$(XamlResourceReferencePath)</XamlResourceReferencePath>
    </PropertyGroup>
  </Target>

  <!-- ✅ NOVÉ: Fallback XAML loading mechanism -->
  <Target Name="SetupXamlFallback" BeforeTargets="Build" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="🔧 Setting up XAML fallback mechanism..." Importance="low" />

    <!-- ✅ Define fallback XAML resource paths -->
    <PropertyGroup>
      <AdvancedDataGridXamlPath>$(MSBuildThisFileDirectory)../content/</AdvancedDataGridXamlPath>
    </PropertyGroup>

    <!-- ✅ Add XAML files as embedded resources if XBF loading fails -->
    <ItemGroup Condition="Exists('$(AdvancedDataGridXamlPath)')">
      <EmbeddedResource Include="$(AdvancedDataGridXamlPath)**/*.xaml">
        <LogicalName>AdvancedWinUiDataGrid.%(RecursiveDir)%(Filename)%(Extension)</LogicalName>
        <Visible>false</Visible>
      </EmbeddedResource>
    </ItemGroup>

    <Message Text="🔧 XAML fallback mechanism configured" Importance="low" />
  </Target>

</Project>