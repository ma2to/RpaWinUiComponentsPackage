<!-- AdvancedWinUiDataGrid/build/RpaWinUiComponents.AdvancedWinUiDataGrid.targets -->
<!-- ✅ KOMPLETNE OPRAVENÉ: MSBuild targets - NETSDK1152 FINAL FIX -->
<Project>

  <!-- ✅ Debug informácie -->
  <Target Name="DebugAdvancedDataGridPackage" BeforeTargets="ResolveReferences" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">
    <Message Text="🔍 AdvancedWinUiDataGrid: Package v1.0.1 loaded via NuGet (NETSDK1152 FINAL FIX)" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: MSBuildThisFile9Directory = $(MSBuildThisFileDirectory)" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: TargetFramework = $(TargetFramework)" Importance="normal" />
  </Target>

  <!-- ✅ KĽÚČOVÁ OPRAVA NETSDK1152: Iba JEDNA unified cesta -->
  <PropertyGroup>
    <!-- ✅ Pevne nastavená normalized cesta - bez fallbackov -->
    <AdvancedDataGridLibPath>$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/</AdvancedDataGridLibPath>
    <AdvancedDataGridContentPath>$(MSBuildThisFileDirectory)../content/</AdvancedDataGridContentPath>
  </PropertyGroup>

  <!-- ✅ Assembly reference - iba ak DLL skutočne existuje a nie je duplicitná -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true' AND '$(AdvancedDataGridLibPath)' != ''">

    <!-- ✅ Main assembly reference - CONDITIONAL aby sa zabránilo duplikátom -->
    <Reference Include="AdvancedWinUiDataGrid" Condition="Exists('$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll')">
      <HintPath>$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll</HintPath>
      <Private>False</Private>
      <ExcludeAssets>runtime</ExcludeAssets>
    </Reference>

  </ItemGroup>

  <!-- ✅ OPRAVENÉ: XBF súbory copying - iba z jedného zdroja -->
  <Target Name="CopyAdvancedDataGridXbfFiles" BeforeTargets="PrepareForBuild" Condition="'$(UseWinUI)' == 'true' AND '$(AdvancedDataGridLibPath)' != ''">
    <Message Text="🎨 Copying XBF files from single unified path: $(AdvancedDataGridLibPath)" Importance="normal" />

    <!-- ✅ Nájdi XBF súbory iba z jednej cesty -->
    <ItemGroup>
      <AdvancedDataGridXbfFiles Include="$(AdvancedDataGridLibPath)*.xbf" />
      <AdvancedDataGridXbfFiles Include="$(AdvancedDataGridLibPath)**/*.xbf" />
    </ItemGroup>

    <!-- ✅ Skopíruj XBF súbory bez duplikátov -->
    <Copy SourceFiles="@(AdvancedDataGridXbfFiles)"
          DestinationFolder="$(OutputPath)%(RecursiveDir)"
          SkipUnchangedFiles="true"
          OverwriteReadOnlyFiles="true"
          UseHardlinksIfPossible="false"
          Condition="'@(AdvancedDataGridXbfFiles)' != ''" />

    <Message Text="✅ Copied @(AdvancedDataGridXbfFiles->Count()) XBF files from unified path without duplicates" Importance="normal" Condition="'@(AdvancedDataGridXbfFiles)' != ''" />
    <Warning Text="⚠️ No XBF files found in unified path: $(AdvancedDataGridLibPath)" Condition="'@(AdvancedDataGridXbfFiles)' == ''" />
  </Target>

  <!-- ✅ WinUI3 specific nastavenia -->
  <PropertyGroup Condition="'$(UseWinUI)' == 'true'">
    <EnableDefaultXamlItems>true</EnableDefaultXamlItems>
    <XamlCompilationEnabled>true</XamlCompilationEnabled>

    <!-- ✅ KĽÚČOVÁ OPRAVA: Potlač duplicate assembly warnings -->
    <ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>None</ResolveAssemblyWarnOrErrorOnTargetArchitectureMismatch>
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);MSB3277;NETSDK1152</MSBuildWarningsAsMessages>

    <!-- ✅ Disable duplicate reference warnings -->
    <DisableImplicitFrameworkReferences>false</DisableImplicitFrameworkReferences>

    <!-- ✅ NETSDK1152 FINAL FIX: Suppress specific packaging warnings -->
    <MSBuildWarningsAsMessages>$(MSBuildWarningsAsMessages);NETSDK1152</MSBuildWarningsAsMessages>
    <NoWarn>$(NoWarn);NETSDK1152</NoWarn>
  </PropertyGroup>

  <!-- ✅ Verification target -->
  <Target Name="VerifyAdvancedDataGridPackage" BeforeTargets="PrepareForBuild" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">

    <PropertyGroup>
      <PackageDllExists Condition="Exists('$(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll')">true</PackageDllExists>
    </PropertyGroup>

    <Message Text="✅ Using UNIFIED lib path (NETSDK1152 FINAL FIX): $(AdvancedDataGridLibPath)" Importance="normal" />
    <Message Text="✅ Package DLL found at unified path: $(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll"
             Importance="normal"
             Condition="'$(PackageDllExists)' == 'true'" />

    <Message Text="🎉 AdvancedWinUiDataGrid package loaded via SINGLE UNIFIED PATH (NETSDK1152 FINAL FIX)!"
             Importance="high"
             Condition="'$(PackageDllExists)' == 'true'" />

    <Error Text="❌ Package DLL not found at unified path: $(AdvancedDataGridLibPath)AdvancedWinUiDataGrid.dll"
           Condition="'$(PackageDllExists)' != 'true'" />
  </Target>

  <!-- ✅ NOVÉ: Clean previous package versions target -->
  <Target Name="CleanPreviousPackageVersions" BeforeTargets="PrepareForBuild" Condition="'$(Configuration)' == 'Debug'">
    <Message Text="🧹 Cleaning previous package versions to prevent NETSDK1152..." Importance="normal" />

    <!-- ✅ Toto target môže byť rozšírené pre cleanup starších verzií -->
    <PropertyGroup>
      <PackageCleanupCompleted>true</PackageCleanupCompleted>
    </PropertyGroup>
  </Target>

  <!-- ✅ NOVÉ: Post-restore verification -->
  <Target Name="PostRestoreVerification" AfterTargets="RestoreComplete" Condition="'$(UseWinUI)' == 'true'">
    <Message Text="📦 Post-restore: AdvancedWinUiDataGrid package verification..." Importance="normal" />
    <Message Text="📦 Unified path: $(AdvancedDataGridLibPath)" Importance="normal" />
    <Message Text="✅ NETSDK1152 prevention measures active" Importance="normal" />
  </Target>

</Project>