<!-- AdvancedWinUiDataGrid/build/RpaWinUiComponents.AdvancedWinUiDataGrid.targets -->
<!-- ✅ KOMPLETNE OPRAVENÝ MSBuild targets pre Package Reference -->
<Project>

  <!-- ✅ Debug informácie (iba v Debug mode) -->
  <Target Name="DebugAdvancedDataGridPackage" BeforeTargets="ResolveReferences" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">
    <Message Text="🔍 AdvancedWinUiDataGrid: Package v1.0.2 loaded via NuGet" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: MSBuildThisFileDirectory = $(MSBuildThisFileDirectory)" Importance="normal" />
    <Message Text="🔍 AdvancedWinUiDataGrid: TargetFramework = $(TargetFramework)" Importance="normal" />
  </Target>

  <!-- ✅ OPRAVENÉ: Package paths s correct TargetFramework handling -->
  <PropertyGroup>
    <!-- Skús najprv konkrétny TFM, potom fallback na generický -->
    <AdvancedDataGridLibPath Condition="Exists('$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/')">$(MSBuildThisFileDirectory)../lib/$(TargetFramework)/</AdvancedDataGridLibPath>
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == '' AND Exists('$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/')">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/</AdvancedDataGridLibPath>
    <AdvancedDataGridLibPath Condition="'$(AdvancedDataGridLibPath)' == ''">$(MSBuildThisFileDirectory)../lib/net8.0-windows10.0.19041.0/</AdvancedDataGridLibPath>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Reference na DLL s lepšou error handling -->
  <ItemGroup Condition="'$(UseWinUI)' == 'true'">
    <Reference Include="RpaWinUiComponents.AdvancedWinUiDataGrid" Condition="Exists('$(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.dll')">
      <HintPath>$(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.dll</HintPath>
      <Private>False</Private>
    </Reference>
  </ItemGroup>

  <!-- ✅ Nastavenie pre WinUI3 XAML kompajlovanie -->
  <PropertyGroup Condition="'$(UseWinUI)' == 'true'">
    <EnableDefaultXamlItems>true</EnableDefaultXamlItems>
    <XamlCompilationEnabled>true</XamlCompilationEnabled>
  </PropertyGroup>

  <!-- ✅ OPRAVENÉ: Debug target pre verifikáciu package obsahu -->
  <Target Name="VerifyAdvancedDataGridPackage" BeforeTargets="PrepareForBuild" Condition="'$(Configuration)' == 'Debug' AND '$(UseWinUI)' == 'true'">

    <PropertyGroup>
      <PackageDllExists Condition="Exists('$(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.dll')">true</PackageDllExists>
      <PackagePdbExists Condition="Exists('$(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.pdb')">true</PackagePdbExists>
    </PropertyGroup>

    <Message Text="✅ Using lib path: $(AdvancedDataGridLibPath)" Importance="normal" />
    <Message Text="✅ Package DLL found: $(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.dll" Importance="normal"
             Condition="'$(PackageDllExists)' == 'true'" />
    <Message Text="✅ Package PDB found: $(AdvancedDataGridLibPath)RpaWinUiComponents.AdvancedWinUiDataGrid.pdb" Importance="normal"
             Condition="'$(PackagePdbExists)' == 'true'" />

    <Warning Text="⚠️ AdvancedWinUiDataGrid: DLL not found at $(AdvancedDataGridLibPath). Package may not be properly installed."
             Condition="'$(PackageDllExists)' != 'true'" />

    <Message Text="📦 TIP: Skús: dotnet restore --force, alebo dotnet clean + dotnet build" Importance="high"
             Condition="'$(PackageDllExists)' != 'true'" />
  </Target>

  <!-- ✅ WinUI3 specific settings -->
  <PropertyGroup Condition="'$(UseWinUI)' == 'true'">
    <!-- Zabezpečiť že WinUI3 ResourceDictionary sú správne načítané -->
    <XamlResourcesEnabled>true</XamlResourcesEnabled>
  </PropertyGroup>

  <!-- ✅ NOVÉ: Fallback ak package nie je nájdený - pokúsi sa auto-restore -->
  <Target Name="AutoRestoreAdvancedDataGridPackage" BeforeTargets="Build" Condition="'$(PackageDllExists)' != 'true' AND '$(UseWinUI)' == 'true'">
    <Message Text="🔄 Attempting auto-restore of AdvancedWinUiDataGrid package..." Importance="high" />

    <Exec Command="dotnet restore --packages $(NuGetPackageRoot)"
          WorkingDirectory="$(MSBuildProjectDirectory)"
          ContinueOnError="true"
          IgnoreExitCode="true" />
  </Target>

</Project>